<!doctype html>
<html>
<head>
	<title>
		Countly Demo
	</title>
	<!--
		//Content security policy
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'"></meta>
	-->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="../../lib/countly.js"></script>
	<script src="./boomerang/boomerang-1.0.0.js"></script>
	<script src="./boomerang/countly_boomerang.js"></script>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" name="viewport">

	<style>
		* {
			margin: 0;
			padding: 0;
		}

		body {
			font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
			box-sizing: border-box;
		}

		a {
			text-decoration: none;
			color: #000;
			padding: 20px;
		}

		#header p {
			padding: 20px;
			cursor: pointer;
		}

		input {
			padding: 8px;
			font-size: 15px;
		}

		@media only screen and (max-width: 900px) {
			body {
				background-color: grey;
			}
		}
	</style>

	<script type='text/javascript'>
		var Countly = Countly || {};
		Countly.q = Countly.q || [];

		Countly.app_key = 'YOUR_APP_KEY';
		Countly.url = 'https://try.count.ly';
		Countly.session_update = 10; //Time interval for session extend
		Countly.use_session_cookie = false; //if false, begin_session on every app open, be it in new tab
		Countly.debug = true;
		Countly.require_consent = true;
		Countly.namespace = "demo";
		Countly.inactivity_time = 1; //User will marked inactive after 1 min, i.e. stop_time and no extend session or end session
		Countly.offline_mode = false;
		Countly.force_post = false;

		Countly.remote_config = function(err, rc) {
			if (err) {
				return;
			}
				$("#header").css({'background-color': rc.header_background_color});
				$("#subscription button").text(rc.sub_text);
		};

		Countly.q.push(['group_features', {
			activity: ["sessions", "events", "views", "location", "remote-config", "apm"],
			interaction: ["scrolls", "clicks", "feedback", "star-rating", "attribution"],
			whereabouts: ["users", "forms"]
		}]);

		if (typeof(localStorage) !== "undefined") {
			var consents = localStorage.getItem("consents");

			if(consents){
				Countly.q.push(['add_consent', JSON.parse(consents)]);
			}
			else{
				var consent = confirm("We are going to track you. Do you give your consent ?");
				consents = ["activity", "interaction", "whereabouts"];
				if(consent) {
					Countly.q.push(['add_consent', consents]);
					localStorage.setItem("consents", JSON.stringify(consents));
				}
				else {
					Countly.q.push(['remove_consent', consents]);
					localStorage.removeItem("consents");
				}
			}
		}

		Countly.q.push(['track_sessions']);
		Countly.q.push(['track_pageview', 'newpage.pts']);
		Countly.q.push(['track_scrolls']);
		Countly.q.push(['track_clicks']);
		Countly.q.push(['track_links', '']);
		Countly.q.push(['track_forms']);
		Countly.q.push(['report_conversion']);
		Countly.q.push(["track_performance", {
			RT:{
				enabled: true
			},
			instrument_xhr: true,
			AutoXHR: {
				enabled: true,
				alwaysSendXhr: true,
				monitorFetch: true,
				captureXhrRequestResponse: true
			},
			Continuity: {
				enabled: true,
				monitorLongTasks: true,
				monitorPageBusy: true,
				monitorFrameRate: true,
				monitorInteractions: true,
				afterOnload: true
			},
			NavigationTiming: {
				enabled: true
			},
			ResourceTiming: {
				enabled: true,
				clearOnBeacon: true,
				urlLimit: 2000,
				splitAtPath: true
			}
		}]);

		function allWidgetsCallback(feedbacks, err) {
			if (err) {
				return console.log("error ", err);
			}

			Countly.present_feedback_widget(feedbacks[0], "itsi", "pts");
		}

		Countly.q.push(["get_available_feedback_widgets", allWidgetsCallback]);

		// Countly.q.push(['enable_feedback',{'widgets':['60757ae320b011f853fce845']}]);

		(function() {
			var cly = document.createElement('script'); cly.type = 'text/javascript';
			cly.async = true;
			cly.src = '../../lib/countly.js';
			cly.onload = function(){
				Countly.init();};
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(cly, s);
		})();

        // Countly.change_id(Countly._internals.generateUUID());

        setTimeout(function() {
            Countly.q.push(['track_forms', $("#mynewform-form")[0]]);
        }, 1000);

	</script>
</head>
<body>

	<div id="header" style="z-index: 100000; width: 100%; height: 100px; display: flex; justify-content: space-between; align-items: center; background-color: #cff96b;">
		<div style="float: left;">
			<a href="/demo">Home</a>
		</div>
		<div>
			<h1 style="text-transform: uppercase;">Countly demo app</h1>
		</div>
		<div style="float: left;">
			<div style="display: inline-block;">
				<p id="user-state"></p>
			</div>
		</div>
	</div>
	<div style="width: 100%; display:flex; justify-content: center; align-items: center;">
		<img src="./team_countly.jpg" />
	</div>
	<center>
		<h1 id="welcome-user" style="text-transform: capitalize;">Welcome</h1>
		<br />
		<div id="subscription">
			<button id="subscription-button" style="color: #000; border: none; padding: 20px; border-radius: 2px; cursor: pointer; font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif; font-size: 20px; background-color: #bed3da;">
				Get started
			</button>
		</div>
		<br />
        <div id="mynewform">
            <form id="mynewform-form">
                <input type="text" placeholder="Enter your email" />
                <input type="submit" />
            </form>
        </div>

        <div id="itsi"></div>
        <div class="pts"></div>
        <div class="pts"></div>
	</center>

	<script>
		var users = [
	{
		"device_id": "mrsparkles-new-3",
		"name": "mrsparkles",
		"username": "mrsparkles",
		"email": "mrsparkles@cly.com",
		"organization": "Countly",
		"phone": "+919882201994",
		"gender": "M",
		"byear": "1994"
	},
	{
		"device_id": "alex-new-3",
		"name": "Alex",
		"username": "alex",
		"email": "alex@cly.com",
		"organization": "Amazom",
		"phone": "+919882202010",
		"gender": "M",
		"byear": "2010"
	},
	{
		"device_id": "hannah-new-3",
		"name": "Hannah",
		"username": "hannah",
		"email": "hannah@cly.com",
		"organization": "Facebook",
		"phone": "+919882202000",
		"gender": "F",
		"byear": "2000"
	},
	{
		"device_id": "jarvis-new-3",
		"name": "Jarvis",
		"username": "jarvis",
		"email": "jarvis@cly.com",
		"organization": "Tony Stark corp",
		"phone": "+919882202013",
		"gender": "F",
		"byear": "2013"
	},
	{
		"device_id": "dummy-jarvis-new-3",
		"name": "Jarvis dummy",
		"username": "jarvis",
		"email": "jarvis@cly.com",
		"organization": "Tony Stark corp",
		"phone": "+919882202013",
		"gender": "F",
		"byear": "2013"
	},
	{
		"device_id": "new-dummy-jarvis-new-3",
		"name": "New Jarvis dummy",
		"username": "jarvis",
		"email": "jarvis@cly.com",
		"organization": "Tony Stark corp",
		"phone": "+919882202013",
		"gender": "F",
		"byear": "2013"
	},
	{
		"device_id": "jarvis-new",
		"name": "Jarvis new",
		"username": "jarvis",
		"email": "jarvis@cly.com",
		"organization": "Tony Stark corp",
		"phone": "+919882202013",
		"gender": "F",
		"byear": "2013"
	},
	{
		"device_id": "sid-new-3",
		"name": "Sid",
		"username": "sid",
		"email": "sid@cly.com",
		"organization": "Avenger",
		"phone": "+919882202018",
		"gender": "M",
		"byear": "2018"
	},
	{
		"device_id": "harry-new-3",
		"name": "Harry",
		"username": "harry",
		"email": "harry@cly.com",
		"organization": "Avenger",
		"phone": "+919882102018",
		"gender": "M",
		"byear": "2005"
	},
		];

		$("#subscription-button").on("click", function() {
			Countly.q.push(['add_event', {
				"key": "subscription-clicked",
				"count": 1,
				"segmentation": {
					"click_by": "mouse",
					"click_on": "august"
				}
			}]);

			var subscribe = confirm("Do you want to subscribe ?");

			if(subscribe) {
				Countly.q.push(['add_event', {
					"key": "subscibed",
					"count": 1
				}]);
			}
			else {
				Countly.q.push(['add_event', {
					"key": "not-subscibed",
					"count": 1
				}]);
			}

            sendAjaxRequest();

            var stz = +new Date();
            for(var i = 0; i< 1000; i++) {}
            var etz = +new Date() + 2000;
            Countly.q.push(["report_trace",{
                type: "device", //device or network
                name: "for_loop", //use name to identify trace and group them by
                stz: stz, //start timestamp in miliseconds
                etz: etz, //end timestamp in miliseconds
                apm_metrics: {
                    duration: etz-stz, //duration of trace
                    bytes: 20
                }
            }]);
		});

		$("#user-state").on("click", function() {
			var loginState = localStorage.getItem("ptsdemo-login-state");

			if(loginState) {
				//User logout
				localStorage.removeItem("ptsdemo-login-state");
				localStorage.removeItem("ptsdemo-user");
				$("#welcome-user").text("Welcome");
				$("#user-state").text("Sign in");
				// $("#subscription").hide();

				Countly.q.push(['change_id', Countly._internals.generateUUID()]);

				//When in offline mode of user management
				// Countly.q.push(['enable_offline_mode']);
			}
			else {
				//User logins
				var login = confirm("Do you want to login ?");
				if(login) {
					var userIndex = getRandomUserIndex();
					var user = users[userIndex];
					$("#welcome-user").text("Welcome " + user.name);
					$("#user-state").text("Sign out");
					// $("#subscription").show();
					localStorage.setItem("ptsdemo-user", userIndex);
					localStorage.setItem("ptsdemo-login-state", true);

					//Change user's device on login - He is now an identified user
					Countly.q.push(['change_id', user.device_id]);

					//When in offline mode of user management
					//In offline mode of user management its better to use manual session management
					// Countly.q.push(['disable_offline_mode', user.device_id]);

					setUserData(user);
				}
			}

            setTimeout(function() {
                location.reload();
            }, 1000)
		});

		var loginState = localStorage.getItem("ptsdemo-login-state");
		if(loginState) {
			//User can signout
			var userIndex = localStorage.getItem("ptsdemo-user");
			var user = users[userIndex];
			$("#welcome-user").text("Welcome " + user.name);
			$("#user-state").text("Sign out");
		}
		else {
			//User can sign in
			$("#user-state").text("Sign in");
		}

		function getRandomUserIndex() {
			return getRandomNumber(0, users.length - 1);
		}

		function setUserData(user) {
			Countly.q.push(['user_details', {
				"name": user.name,
				"username": user.username,
				"email": user.email,
				"organization": user.organization,
				"phone": user.phone,
				"gender": user.gender,
				"byear": user.byear,
				"custom": {
					"emailLogin": ["false"],
					"accountType": "premium"
				}
			}]);
		}

		function getRandomNumber(min, max) {
			return parseInt(Math.random() * (max - min) + min);
		}
	</script>
</body>
