<!doctype html>
<html>

<head>
    <title>
        Countly Web Demo
    </title>
    <!--
		//Content security policy
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'"></meta>
	-->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="../../lib/countly.js"></script>
    <script src="./boomerang/boomerang-1.0.0.js"></script>
    <script src="./boomerang/countly_boomerang.js"></script>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" name="viewport">
    <!-- Page styling here -->
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
            box-sizing: border-box;
        }
        
        a {
            text-decoration: none;
            color: #000;
            padding: 20px;
        }
        
        #header p {
            padding: 20px;
            cursor: pointer;
        }
        
        input {
            padding: 8px;
            font-size: 15px;
        }
        
        @media only screen and (max-width: 900px) {
            body {
                background-color: grey;
            }
        }
    </style>
    <!-- Async Countly init logic here -->
    <script type='text/javascript'>
        var Countly = Countly || {};
        Countly.q = Countly.q || [];
        //Countly config
        Countly.app_key = 'YOUR_APP_KEY';
        Countly.url = 'https://try.count.ly';
        Countly.session_update = 10; //Time interval for session extend
        Countly.use_session_cookie = false; //if false, begin_session on every app open, be it in new tab
        Countly.debug = true;
        Countly.require_consent = true;
        Countly.namespace = "demo";
        Countly.inactivity_time = 1; //User will marked inactive after 1 min, i.e. stop_time and no extend session or end session
        Countly.offline_mode = false;
        Countly.force_post = false;
        //Example usage of remote config to fetch remote configurations 
        Countly.remote_config = function(err, rc) {
            if (err) {
                return;
            }
            console.log(rc);
            //DO SOMETHING
            //...
        };
        //(optionally) provide custom feature tree if needed
        Countly.q.push(['group_features', {
            activity: ["sessions", "events", "views", "location", "remote-config", "apm"],
            interaction: ["scrolls", "clicks", "feedback", "star-rating", "attribution"],
            whereabouts: ["users", "forms"]
        }]);
        //handling consent here
        if (typeof(localStorage) !== "undefined") {
            //check if consent is stored
            var consents = localStorage.getItem("consents");

            if (consents) {
                Countly.q.push(['add_consent', JSON.parse(consents)]);
            } else {
                //prompt user for consent
                var consent = confirm("We are going to track you. Do you give your consent ?");
                consents = ["activity", "interaction", "whereabouts"];
                if (consent) {
                    Countly.q.push(['add_consent', consents]);
                    localStorage.setItem("consents", JSON.stringify(consents));
                } else {
                    Countly.q.push(['remove_consent', consents]);
                    localStorage.removeItem("consents");
                }
            }
        }
        //tracking user actions
        Countly.q.push(['track_sessions']);
        Countly.q.push(['track_pageview']);
        //For heatmaps record scrolls and clicks
        Countly.q.push(['track_scrolls']);
        Countly.q.push(['track_clicks']);
        Countly.q.push(['track_links', '']);
        Countly.q.push(['track_forms']);
        Countly.q.push(['recordDirectAttribution']);
        Countly.q.push(["track_performance", {
            RT: {
                enabled: true
            },
            instrument_xhr: true,
            AutoXHR: {
                enabled: true,
                alwaysSendXhr: true,
                monitorFetch: true,
                captureXhrRequestResponse: true
            },
            Continuity: {
                enabled: true,
                monitorLongTasks: true,
                monitorPageBusy: true,
                monitorFrameRate: true,
                monitorInteractions: true,
                afterOnload: true
            },
            NavigationTiming: {
                enabled: true
            },
            ResourceTiming: {
                enabled: true,
                clearOnBeacon: true,
                urlLimit: 2000,
                splitAtPath: true
            }
        }]);

        //init countly
        (function() {
            var cly = document.createElement('script');
            cly.type = 'text/javascript';
            cly.async = true;
            cly.src = '../../lib/countly.js';
            cly.onload = function() {
                Countly.init();
            };
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(cly, s);
        })();
        //Uncomment to change device id randomly
        // Countly.change_id(Countly._internals.generateUUID());

        setTimeout(function() {
            Countly.q.push(['track_forms', $("#mynewform-form")[0]]);
        }, 1000);
    </script>
</head>

<body>

    <div id="header" style="z-index: 100000; width: 100%; height: 100px; display: flex; justify-content: space-between; align-items: center; background-color: #cff96b;">
        <div style="float: left;">
            <a href="/demo">Home</a>
        </div>
        <div>
            <h1 style="text-transform: uppercase;">Countly demo app</h1>
        </div>
        <div style="float: left;">
            <div style="display: inline-block;">
                <p id="user-state"></p>
            </div>
        </div>
    </div>
    <div style="width: 100%; display:flex; justify-content: center; align-items: center;">
        <img src="./team_countly.jpg" />
    </div>
    <center>
        <h1 id="welcome-user" style="text-transform: capitalize;">Welcome</h1>
        <br />
        <div id="subscription">
            <button id="subscription-button" style="color: #000000; border: none; padding: 5px; border-radius: 2px; cursor: pointer; font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif; font-size: 14px; background-color: #bed3da;">
				Get started (send events)
			</button>
            <button id="nps" style="color: #000; border: none; padding: 5px; border-radius: 2px; cursor: pointer; font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif; font-size: 14px; background-color: #bed3da;">
				Show NPS
			</button>
            <button id="survey" style="color: #000; border: none; padding: 5px; border-radius: 2px; cursor: pointer; font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif; font-size: 14px; background-color: #bed3da;">
				Show Survey
			</button>
            <button id="rating" style="color: #000; border: none; padding: 5px; border-radius: 2px; cursor: pointer; font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif; font-size: 14px; background-color: #bed3da;">
				Show Rating Widget
			</button>
            <button id="random" style="color: #000; border: none; padding: 5px; border-radius: 2px; cursor: pointer; font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif; font-size: 14px; background-color: #bed3da;">
				Show Random Feedback Widget
			</button>
            <button id="rating-enable" style="color: #000; border: none; padding: 5px; border-radius: 2px; cursor: pointer; font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif; font-size: 14px; background-color: #bed3da;">
				Show Old Rating Widget
			</button>
            <button id="rating-multi" style="color: #000; border: none; padding: 5px; border-radius: 2px; cursor: pointer; font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif; font-size: 14px; background-color: #bed3da;">
				Show Old Rating Widget (Multi)
			</button>
        </div>
        <br />
        <div id="mynewform">
            <form id="mynewform-form">
                <input type="text" placeholder="Enter your email" />
                <input type="submit" />
            </form>
        </div>
        <!-- Some empty elements to append feedback widgets -->
        <div id="itsi"></div>
        <div class="pts"></div>
        <div class="pts"></div>
    </center>

    <script>
        //some dummy user details 
    var users = [{
            "device_id": "mrsparkles-new-3",
            "name": "mrsparkles",
            "username": "mrsparkles",
            "email": "mrsparkles@cly.com",
            "organization": "Countly",
            "phone": "+919882201994",
            "gender": "M",
            "byear": "1994"
        }, {
            "device_id": "alex-new-3",
            "name": "Alex",
            "username": "alex",
            "email": "alex@cly.com",
            "organization": "Amazoom",
            "phone": "+919882202010",
            "gender": "M",
            "byear": "2010"
        }, {
            "device_id": "hannah-new-3",
            "name": "Hannah",
            "username": "hannah",
            "email": "hannah@cly.com",
            "organization": "Pacebook",
            "phone": "+919882202000",
            "gender": "F",
            "byear": "2000"
        }, {
            "device_id": "jarvis-new-3",
            "name": "Jarvis",
            "username": "jarvis",
            "email": "jarvis@cly.com",
            "organization": "Toby Stark corp",
            "phone": "+919882202013",
            "gender": "F",
            "byear": "2013"
        }, {
            "device_id": "dummy-jarvis-new-3",
            "name": "Jarvis dummy",
            "username": "jarvis",
            "email": "jarvis@cly.com",
            "organization": "Toby Stark corp",
            "phone": "+919882202013",
            "gender": "F",
            "byear": "2013"
        }, {
            "device_id": "new-dummy-jarvis-new-3",
            "name": "New Jarvis dummy",
            "username": "jarvis",
            "email": "jarvis@cly.com",
            "organization": "Toby Stark corp",
            "phone": "+919882202013",
            "gender": "F",
            "byear": "2013"
        }, {
            "device_id": "jarvis-new",
            "name": "Jarvis new",
            "username": "jarvis",
            "email": "jarvis@cly.com",
            "organization": "Toby Stark corp",
            "phone": "+919882202013",
            "gender": "F",
            "byear": "2013"
        }, {
            "device_id": "sid-new-3",
            "name": "Sid",
            "username": "sid",
            "email": "sid@cly.com",
            "organization": "Cavenger",
            "phone": "+919882202018",
            "gender": "M",
            "byear": "2018"
        }, {
            "device_id": "harry-new-3",
            "name": "Harry",
            "username": "harry",
            "email": "harry@cly.com",
            "organization": "Adventure",
            "phone": "+919882102018",
            "gender": "M",
            "byear": "2005"
        }, ];
        //add custom events by clicking subscription
        $("#subscription-button").on("click", function() {
            Countly.q.push(['add_event', {
                "key": "subscription-clicked",
                "count": 1,
                "segmentation": {
                    "click_by": "mouse",
                    "click_on": "august"
                }
            }]);

            var subscribe = confirm("Do you want to subscribe ?");

            if (subscribe) {
                Countly.q.push(['add_event', {
                    "key": "subscribed",
                    "count": 1
                }]);
            } else {
                Countly.q.push(['add_event', {
                    "key": "not-subscribed",
                    "count": 1
                }]);
            }
        });
        //fetch nps widgets
        $("#nps").on("click", function() {
            Countly.q.push(["get_available_feedback_widgets", allWidgetsCallbackNPS]);
        });
        //fetch survey widgets
        $("#survey").on("click", function() {
            Countly.q.push(["get_available_feedback_widgets", allWidgetsCallbackSurvey]);
        });
         //fetch rating widgets
         $("#rating").on("click", function() {
            Countly.q.push(["get_available_feedback_widgets", allWidgetsCallbackRating]);
        });
         //fetch random feedback widgets
         $("#random").on("click", function() {
            Countly.q.push(["get_available_feedback_widgets", allWidgetsCallbackRandom]);
        });
        //display a rating widget with ID
        $("#rating-enable").on("click", function() {
            let id = prompt("Please enter widget ID");
            if (!id) {
                return;
            } else {
                Countly.enableRatingWidgets({
                    'popups': [id]
                });
            }
        });
        //display multiple rating widgets with IDs
        $("#rating-multi").on("click", function() {
            let ids = prompt("Please enter widget IDs separated with commas");
            if (!ids) {
                return;
            } else {
                //trim whitespace
                const idArray = ids.split(',').map(a=>a.trim());
                Countly.initializeRatingWidgets(idArray);
            }
        });
        //log in logic here
        $("#user-state").on("click", function() {
            var loginState = localStorage.getItem("ptsdemo-login-state");

            if (loginState) {
                //User logout
                localStorage.removeItem("ptsdemo-login-state");
                localStorage.removeItem("ptsdemo-user");
                $("#welcome-user").text("Welcome");
                $("#user-state").text("Sign in");
                // $("#subscription").hide();

                Countly.q.push(['change_id', Countly._internals.generateUUID()]);

                //When in offline mode of user management
                // Countly.q.push(['enable_offline_mode']);
            } else {
                //User logins
                var login = confirm("Do you want to login ?");
                if (login) {
                    var userIndex = getRandomUserIndex();
                    var user = users[userIndex];
                    $("#welcome-user").text("Welcome " + user.name);
                    $("#user-state").text("Sign out");
                    // $("#subscription").show();
                    localStorage.setItem("ptsdemo-user", userIndex);
                    localStorage.setItem("ptsdemo-login-state", true);

                    //Change user's device on login - He is now an identified user
                    Countly.q.push(['change_id', user.device_id]);

                    //When in offline mode of user management
                    //In offline mode of user management its better to use manual session management
                    // Countly.q.push(['disable_offline_mode', user.device_id]);

                    setUserData(user);
                }
            }

            setTimeout(function() {
                location.reload();
            }, 1000)
        });

        function getRandomUserIndex() {
            return getRandomNumber(0, users.length - 1);
        }

        function setUserData(user) {
            Countly.q.push(['user_details', {
                "name": user.name,
                "username": user.username,
                "email": user.email,
                "organization": user.organization,
                "phone": user.phone,
                "gender": user.gender,
                "byear": user.byear,
                "custom": {
                    "emailLogin": ["false"],
                    "accountType": "premium"
                }
            }]);
        }

        function getRandomNumber(min, max) {
            return parseInt(Math.random() * (max - min) + min);
        }
        //callback to choose an nps widget from the fetched widget list, widget is the index of the desired widget in the widget list
        function allWidgetsCallbackRandom(feedbacks, err) {
            if (err) {
                return console.log("error ", err);
             }
            //random widget to fetch
            var widget = getRandomNumber(0, feedbacks.length);
            Countly.present_feedback_widget(feedbacks[widget], "", "pts");
        }
        //callback to choose an nps widget from the fetched widget list, widget is the index of the desired widget in the widget list
        function allWidgetsCallbackNPS(feedbacks, err) {
            if (err) {
                return console.log("error ", err);
            }
            //first nps widget to fetch
            var widget = 0;
            var i = 0;
            while(i < feedbacks.length) {
                if (feedbacks[i].type === 'nps') {
                    widget = i;
                    i = feedbacks.length;
                    Countly.present_feedback_widget(feedbacks[widget], "", "pts");
                }
                i++;
            }
        }
        //callback to choose a survey widget from the fetched widget list, widget is the index of the desired widget in the widget list
        function allWidgetsCallbackSurvey(feedbacks, err) {
            if (err) {
                return console.log("error ", err);
            }
            //first survey widget to fetch
            var widget = 0;
            var i = 0;
            while(i < feedbacks.length) {
                if (feedbacks[i].type === 'survey') {
                    widget = i;
                    i = feedbacks.length;
                    Countly.present_feedback_widget(feedbacks[widget], "itsi", "");
                }
                i++;
            }
            //an appearance object to attach fo testing purposes
            // feedbacks.appearance = { 
            //     show: "uClose", 
            //     position: "bLeft", 
            //     color: "#2eb52b",
            //     next: "Next",
            //     position: "bLeft",
            //     previous: "Previous",
            //     show: "uClose",
            //     submit: "Submit"
            //     }
        }
        
        //callback to choose rating widget from the fetched widget list, widget is the index of the desired widget in the widget list
        function allWidgetsCallbackRating(feedbacks, err) {
            if (err) {
                return console.log("error ", err);
            }
            //first rating widget to fetch
            var widget = 0;
            var i = 0;
            while(i < feedbacks.length) {
                if (feedbacks[i].type === 'rating') {
                    widget = i;
                    i = feedbacks.length;
                    Countly.present_feedback_widget(feedbacks[widget], "", "pts");
                }
                i++;
            }
        }
    </script>
</body>